# Sistema de Recomenda√ß√µes - Documenta√ß√£o Completa

## üìã Vis√£o Geral

Sistema de recomenda√ß√µes inteligente para Laravel que sugere campanhas e posts aos usu√°rios baseado em:
- **Prefer√™ncias do usu√°rio** (sistemas, estilos, din√¢micas)
- **Tags e categorias** (similaridade de conte√∫do)
- **Hist√≥rico de intera√ß√µes** (likes, visualiza√ß√µes, coment√°rios)
- **Rede social** (recomenda√ß√µes de amigos)
- **Filtros personalizados** (whitelist/blacklist de tags)

## üèóÔ∏è Arquitetura

### Componentes Principais

```
app/
‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îî‚îÄ‚îÄ RecommendationService.php          # L√≥gica principal do algoritmo
‚îú‚îÄ‚îÄ Http/Controllers/
‚îÇ   ‚îî‚îÄ‚îÄ RecommendationController.php      # Endpoints da API
‚îú‚îÄ‚îÄ Http/Resources/
‚îÇ   ‚îú‚îÄ‚îÄ RecommendationResource.php        # Formata√ß√£o de resposta
‚îÇ   ‚îî‚îÄ‚îÄ RecommendationCollection.php      # Cole√ß√£o de recomenda√ß√µes
‚îú‚îÄ‚îÄ Jobs/
‚îÇ   ‚îî‚îÄ‚îÄ GenerateRecommendationsJob.php    # Job para processamento em lote
‚îú‚îÄ‚îÄ Console/Commands/
‚îÇ   ‚îî‚îÄ‚îÄ GenerateRecommendationsCommand.php # Comando CLI
‚îî‚îÄ‚îÄ Models/
    ‚îî‚îÄ‚îÄ Recommendation.php                # Modelo de dados
```

## üßÆ Algoritmo de Score

### F√≥rmula Principal

```
Score = (Peso_Prefs √ó Score_Prefs) + (Peso_Tags √ó Score_Tags) + 
        (Peso_Interactions √ó Score_Interactions) + (Peso_Friends √ó Score_Friends)
```

### Pesos Configurados

- **Prefer√™ncias**: 40% (sistemas, estilos, din√¢micas)
- **Tags**: 30% (similaridade de conte√∫do)
- **Intera√ß√µes**: 20% (hist√≥rico de comportamento)
- **Amigos**: 10% (recomenda√ß√µes sociais)

### C√°lculo de Scores

#### 1. Score de Prefer√™ncias (0-1)
- **Sistemas**: +0.4 se sistema preferido
- **Estilos**: +0.3 √ó (tags_matching / total_preferences)
- **Din√¢micas**: +0.3 √ó (tags_matching / total_preferences)

#### 2. Score de Tags (0-1)
- Baseado na frequ√™ncia de tags do usu√°rio
- Similaridade = tags_comuns / tags_populares_do_usuario

#### 3. Score de Intera√ß√µes (0-1)
- Intera√ß√µes positivas: like, join, view, comment
- Intera√ß√µes negativas: dislike, leave, block
- Score = 0.3 + (ratio_positivo √ó 0.7)

#### 4. Score de Amigos (0-1)
- Baseado em intera√ß√µes de amigos com o mesmo conte√∫do
- Score = 0.2 + (intera√ß√µes_amigos √ó 0.1)

## üöÄ Instala√ß√£o e Configura√ß√£o

### Pr√©-requisitos

```bash
# Redis (recomendado para cache)
sudo apt-get install redis-server

# Meilisearch (opcional, para busca avan√ßada)
curl -L https://install.meilisearch.com | sh
```

### Configura√ß√£o do Cache

```php
// config/cache.php
'default' => env('CACHE_DRIVER', 'redis'),

'stores' => [
    'redis' => [
        'driver' => 'redis',
        'connection' => 'default',
    ],
],
```

### Configura√ß√£o do Scout (Opcional)

```php
// config/scout.php
'meilisearch' => [
    'host' => env('SCOUT_MEILISEARCH_HOST', 'http://localhost:7700'),
    'key' => env('SCOUT_MEILISEARCH_KEY', null),
    'index-settings' => [
        'recommendations' => [
            'filterableAttributes' => ['target_type', 'score'],
            'sortableAttributes' => ['score', 'generated_at'],
        ],
    ],
],
```

### Vari√°veis de Ambiente

```env
# Cache
CACHE_DRIVER=redis
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

# Scout (opcional)
SCOUT_DRIVER=meilisearch
SCOUT_MEILISEARCH_HOST=http://localhost:7700
SCOUT_MEILISEARCH_KEY=your-key-here
SCOUT_QUEUE=false
```

## üìä Estrutura do Banco de Dados

### Tabela `recommendations`

```sql
CREATE TABLE recommendations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    target_type VARCHAR(20) NULL,        -- 'campaign' ou 'post'
    target_id BIGINT NULL,
    score DECIMAL(5,2) NULL,             -- Score de 0.00 a 1.00
    reason TEXT NULL,                    -- Explica√ß√£o da recomenda√ß√£o
    generated_at TIMESTAMP NULL,
    valid_until TIMESTAMP NULL,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_score (user_id, score),
    INDEX idx_target (target_type, target_id),
    INDEX idx_validity (valid_until)
);
```

### Tabelas Relacionadas (J√° Existentes)

- `users` - Usu√°rios do sistema
- `user_preferences` - Prefer√™ncias (sistemas, estilos, din√¢micas)
- `user_filters` - Filtros (whitelist/blacklist de tags)
- `interaction_events` - Hist√≥rico de intera√ß√µes
- `campaigns` - Campanhas
- `posts` - Posts
- `tags` - Tags e categorias
- `friendships` - Relacionamentos de amizade

## üîß Uso da API

### Endpoints Dispon√≠veis

#### 1. Listar Recomenda√ß√µes
```http
GET /api/recommendations
```

**Par√¢metros:**
- `limit` (int): N√∫mero de recomenda√ß√µes (1-50, padr√£o: 10)
- `type` (string): Tipo de conte√∫do ('campaign', 'post', 'all')
- `min_score` (float): Score m√≠nimo (0-1, padr√£o: 0.1)
- `refresh` (boolean): For√ßar atualiza√ß√£o do cache

**Resposta:**
```json
{
    "success": true,
    "data": {
        "data": [
            {
                "id": 1,
                "target_type": "campaign",
                "target_id": 123,
                "score": 0.85,
                "reason": "Sistema preferido: D&D 5e, Tags de interesse em comum",
                "generated_at": "2024-01-15T10:30:00Z",
                "valid_until": "2024-01-22T10:30:00Z",
                "is_valid": true,
                "target": {
                    "id": 123,
                    "name": "A Jornada dos Cinco An√©is",
                    "description": "Uma aventura √©pica...",
                    "system": "D&D 5e",
                    "owner": {...},
                    "tags": [...]
                },
                "score_percentage": 85.0,
                "days_until_expiry": 7
            }
        ],
        "meta": {
            "total": 1,
            "types": {"campaign": 1, "post": 0},
            "score_range": {"min": 0.85, "max": 0.85, "avg": 0.85}
        }
    },
    "message": "Recomenda√ß√µes recuperadas com sucesso"
}
```

#### 2. Gerar Novas Recomenda√ß√µes
```http
POST /api/recommendations/generate
```

**Par√¢metros:**
- `limit` (int): N√∫mero de recomenda√ß√µes (1-50, padr√£o: 10)
- `force` (boolean): For√ßar gera√ß√£o mesmo com recomenda√ß√µes recentes

#### 3. Marcar como Visualizada
```http
POST /api/recommendations/{id}/view
```

#### 4. Estat√≠sticas
```http
GET /api/recommendations/stats
```

#### 5. Limpar Cache
```http
DELETE /api/recommendations/cache
```

## üñ•Ô∏è Comandos CLI

### Gerar Recomenda√ß√µes

```bash
# Para usu√°rio espec√≠fico
php artisan recommendations:generate --user=123 --limit=20

# Para todos os usu√°rios ativos
php artisan recommendations:generate --batch

# For√ßar gera√ß√£o (ignorar recomenda√ß√µes recentes)
php artisan recommendations:generate --force

# Limpar cache antes de gerar
php artisan recommendations:generate --clear-cache
```

### Agendamento Autom√°tico

```php
// app/Console/Kernel.php
protected function schedule(Schedule $schedule)
{
    // Gerar recomenda√ß√µes diariamente √†s 2h
    $schedule->command('recommendations:generate --batch')
             ->dailyAt('02:00')
             ->withoutOverlapping();
             
    // Limpar recomenda√ß√µes expiradas semanalmente
    $schedule->command('recommendations:cleanup')
             ->weekly()
             ->sundays()
             ->at('03:00');
}
```

## üîÑ Jobs e Filas

### Processamento em Lote

```php
// Despachar job para usu√°rio espec√≠fico
GenerateRecommendationsJob::dispatch($userId, $limit, $force);

// Processar em lotes
$users = User::active()->pluck('id');
foreach (array_chunk($users->toArray(), 50) as $batch) {
    foreach ($batch as $userId) {
        GenerateRecommendationsJob::dispatch($userId, 20, false);
    }
}
```

### Configura√ß√£o de Filas

```php
// config/queue.php
'connections' => [
    'redis' => [
        'driver' => 'redis',
        'connection' => 'default',
        'queue' => env('REDIS_QUEUE', 'default'),
        'retry_after' => 90,
        'block_for' => null,
    ],
],
```

## üß™ Testes

### Executar Testes

```bash
# Testes unit√°rios
php artisan test tests/Unit/RecommendationServiceTest.php

# Testes de integra√ß√£o
php artisan test tests/Feature/RecommendationControllerTest.php

# Todos os testes
php artisan test
```

### Cobertura de Testes

- ‚úÖ Gera√ß√£o de recomenda√ß√µes
- ‚úÖ C√°lculo de scores
- ‚úÖ Filtros de usu√°rio
- ‚úÖ Cache e performance
- ‚úÖ Endpoints da API
- ‚úÖ Valida√ß√£o de par√¢metros
- ‚úÖ Autentica√ß√£o e autoriza√ß√£o

## üìà Monitoramento e M√©tricas

### Logs Importantes

```php
// Logs de gera√ß√£o
Log::info('Recomenda√ß√µes geradas para usu√°rio', [
    'user_id' => $userId,
    'count' => $recommendationCount,
    'avg_score' => $averageScore
]);

// Logs de erro
Log::error('Erro ao gerar recomenda√ß√µes', [
    'user_id' => $userId,
    'error' => $exception->getMessage()
]);
```

### M√©tricas Recomendadas

1. **Taxa de Gera√ß√£o**: % de usu√°rios com recomenda√ß√µes
2. **Score M√©dio**: Qualidade das recomenda√ß√µes
3. **Taxa de Convers√£o**: % de recomenda√ß√µes que geram intera√ß√£o
4. **Performance**: Tempo de gera√ß√£o e cache hit rate
5. **Cobertura**: % de usu√°rios com prefer√™ncias preenchidas

## üîß Personaliza√ß√£o

### Ajustar Pesos do Algoritmo

```php
// app/Services/RecommendationService.php
private const WEIGHT_PREFERENCES = 0.4;  // Aumentar para dar mais peso √†s prefer√™ncias
private const WEIGHT_TAGS = 0.3;         // Aumentar para dar mais peso √†s tags
private const WEIGHT_INTERACTIONS = 0.2; // Aumentar para dar mais peso ao hist√≥rico
private const WEIGHT_FRIENDS = 0.1;      // Aumentar para dar mais peso √†s redes sociais
```

### Adicionar Novos Fatores

```php
// Exemplo: Score baseado em localiza√ß√£o
private function calculateLocationScore(User $user, $target): float
{
    // Implementar l√≥gica de proximidade geogr√°fica
    return 0.5; // Score neutro por padr√£o
}
```

### Configurar Cache

```php
// Ajustar TTL do cache
private const CACHE_TTL = 3600; // 1 hora (ajustar conforme necess√°rio)

// Cache por padr√£o de usu√°rio
Cache::tags(['recommendations', "user:{$userId}"])->remember(...);
```

## üö® Troubleshooting

### Problemas Comuns

#### 1. Recomenda√ß√µes Vazias
```bash
# Verificar se usu√°rio tem prefer√™ncias
SELECT * FROM user_preferences WHERE user_id = ?;

# Verificar se h√° conte√∫do eleg√≠vel
SELECT COUNT(*) FROM campaigns WHERE status = 'active' AND visibility = 'public';
```

#### 2. Performance Lenta
```bash
# Verificar √≠ndices do banco
SHOW INDEX FROM recommendations;

# Verificar cache Redis
redis-cli KEYS "recommendations:*"
```

#### 3. Jobs Falhando
```bash
# Verificar logs da fila
tail -f storage/logs/laravel.log | grep "GenerateRecommendationsJob"

# Verificar status da fila
php artisan queue:work --verbose
```

### Comandos de Diagn√≥stico

```bash
# Verificar recomenda√ß√µes de um usu√°rio
php artisan tinker
>>> App\Models\Recommendation::where('user_id', 1)->get();

# Limpar cache manualmente
php artisan cache:clear
php artisan config:clear

# Verificar configura√ß√£o do Redis
redis-cli ping
```

## üìö Exemplos de Uso

### Frontend (JavaScript)

```javascript
// Buscar recomenda√ß√µes
async function getRecommendations(limit = 10, type = 'all') {
    const response = await fetch(`/api/recommendations?limit=${limit}&type=${type}`, {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    });
    
    return await response.json();
}

// Gerar novas recomenda√ß√µes
async function generateRecommendations(force = false) {
    const response = await fetch('/api/recommendations/generate', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ force })
    });
    
    return await response.json();
}

// Marcar como visualizada
async function markAsViewed(recommendationId) {
    const response = await fetch(`/api/recommendations/${recommendationId}/view`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    });
    
    return await response.json();
}
```

### Backend (PHP)

```php
// Usar o service diretamente
$recommendationService = app(RecommendationService::class);

// Gerar recomenda√ß√µes
$recommendations = $recommendationService->generateRecommendations($userId, 10);

// Salvar no banco
$recommendationService->saveRecommendations($userId, $recommendations);

// Limpar cache
$recommendationService->clearUserCache($userId);
```

## üîí Seguran√ßa

### Valida√ß√µes Implementadas

- ‚úÖ Autentica√ß√£o obrigat√≥ria em todos os endpoints
- ‚úÖ Autoriza√ß√£o: usu√°rios s√≥ acessam suas pr√≥prias recomenda√ß√µes
- ‚úÖ Valida√ß√£o de par√¢metros de entrada
- ‚úÖ Rate limiting (implementar se necess√°rio)
- ‚úÖ Sanitiza√ß√£o de dados de entrada

### Recomenda√ß√µes de Seguran√ßa

1. **Rate Limiting**: Implementar limite de requisi√ß√µes por usu√°rio
2. **Auditoria**: Log de todas as a√ß√µes de recomenda√ß√£o
3. **Valida√ß√£o**: Sanitizar todos os inputs do usu√°rio
4. **Cache**: N√£o armazenar dados sens√≠veis no cache

## üìù Changelog

### v1.0.0 (2024-01-15)
- ‚úÖ Sistema b√°sico de recomenda√ß√µes
- ‚úÖ Algoritmo de score configur√°vel
- ‚úÖ API REST completa
- ‚úÖ Jobs para processamento em lote
- ‚úÖ Comandos CLI
- ‚úÖ Testes unit√°rios e de integra√ß√£o
- ‚úÖ Documenta√ß√£o completa

## ü§ù Contribui√ß√£o

### Como Contribuir

1. Fork do reposit√≥rio
2. Criar branch para feature (`git checkout -b feature/nova-funcionalidade`)
3. Implementar com testes
4. Commit das mudan√ßas (`git commit -am 'Adiciona nova funcionalidade'`)
5. Push para branch (`git push origin feature/nova-funcionalidade`)
6. Criar Pull Request

### Padr√µes de C√≥digo

- PSR-12 para PHP
- Testes obrigat√≥rios para novas funcionalidades
- Documenta√ß√£o atualizada
- Commits em portugu√™s brasileiro

## üìû Suporte

Para d√∫vidas ou problemas:

1. Verificar esta documenta√ß√£o
2. Consultar logs do sistema
3. Executar testes para diagn√≥stico
4. Abrir issue no reposit√≥rio

---

**Sistema de Recomenda√ß√µes v1.0.0** - Desenvolvido para Laravel 10/11 com PostgreSQL
